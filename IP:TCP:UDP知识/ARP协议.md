## ARP协议

>  简单来说，arp协议最主要的功能就是去应答mac地址和请求mac地址。

**主机A 192.168.0.120 -----> 主机B 192.168.0.121**

1. A给B发送UDP包，但是没有mac地址，只有IP地址，就发送ARP请求获取B的MAC地址，此时发出去的包，目标的mac地址被设成了ff:ff:ff:ff:ff:ff，即广播地址，该广播地址作用在第二层（数据链路层）

2. 路由收到arp请求后，广播给局域网内主机。

3. 局域网内的主机会将自己的ip地址和arp请求中的ip地址匹配，如果匹配成功就讲arp结果返回给主机A，内容有（B的IP和mac地址，A的ip和mac地址）

4. A收到arp结果，拿到B的mac地址，再发送udp包

5. 后续A再次向B发送数据报，会先去arp缓存中拿mac地址

6. 主机A重启之后，arp缓存会清空。



### **ARP解析MAC地址**的过程：

**第一步：**

上层应用产生数据，这里用FTP协议为例，在FTP协议中定位了目的IP。

**第二步：**

那么，封装的过程如下：

- 应用层：需要FTP的控制信息，包括用户名、密码等;
- 传输层：目的端口号为21，源为随机端口号;
- 网络层：目的IP为172.16.1.200，源IP为172.16.1.1;
- 数据链路层：因为不知道目的IP 172.16.1.200对应的MAC，所以目的IP到目的MAC的封装映射失败;

三层到二层的封装失败，由于二层是以太网，**ARP的工作机制**便会产生ARP Request去解析目的MAC，此时，源MAC为数据发起者的MAC，目的MAC地址为FFFF:FFFF:FFFF（代表所有MAC）

**第三步：**

ARP Request到达本网段中的所有设备上，因为目的为FFFF:FFFF:FFFF，所以所有设备都可以拆掉二层的封装，然后解读ARP数据包中需要解析的目的IP。

**第四步：**

目的IP不正确的设备直接忽略这个ARP请求包，目的IP正确的设备，会产生一个ARP Reply去回应这个ARP Request。

此时，二层的源MAC为被解析设备的MAC，目的为ARP解析发起者的MAC。

**第五步：**

数据的发起者接到ARP Reply后，将目的IP与目的MAC的对应关系添加到自己的ARP表中。

**第六步：**

之前未完成二层封装的FTP数据，这时重新开始封装二层头部，此时，正确的目的MAC就被封装到了整个数据帧中。

只有完成了整个TCP/IP协议栈封装的数据帧，才能正常的从主机上发出去。

这就是ARP解析MAC地址的整个过程。



## 毒化ARP

​	中间人将发送一个错误的ARP回应包(中间人的mac，路由器的IP)，伪造自己是一个路由器。目标主机接收到之后会保存在自己的arp缓存中。

紧接着目标主机向路由器发送正常数据，会将路由器的IP映射成中间人的mac地址，然后发出去。中间人收到包之后。会监听网卡上的信息，从而窃取信息。之后将ip包转发到正确的地址，比如路由器。前提是需要开启IP转发功能，否则该ip包会被丢弃。

ARP欺骗一般目的是把自己伪装成网关，但如果不作处理，当被欺骗数据包到达后就会被本机丢弃（因为自己到底不是网关，还不知道如何处理这类数据包），这当然是不允许的。开启IP转发功能可以解决该问题，IP转发负责把该类数据包再转发给真正的网关处理，开启IP转发的方法如下：



> 开启ip转发功能，充当路由器

sysctl -w net.inet.ip.forwarding=1

如果不开启，攻击主机将会在收到错误的ip包之后将其丢弃



















